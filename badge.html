<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Tessera operatore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --sb-valid: #00cc55;
      --sb-expired: #ff2e2e;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e9f2ff 0, #dfe7f3 35%, #cfd4dd 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      position: relative;
      max-width: 380px;
      width: 100%;
      padding: 22px 22px 18px;
      border-radius: 20px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
      color: #fff;
      text-align: center;
      overflow: hidden;
      background: #222;
      backdrop-filter: blur(8px);
    }

    /* Barra brand Studio Borghi */
    .brand-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
    }

    .brand-logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 800;
      background: radial-gradient(circle at 30% 0, #fff 0, #f5b300 45%, #ff7a00 100%);
      color: #1b2734;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .brand-title {
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .card-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      opacity: 0.88;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Stati colore */
    .valid {
      background: linear-gradient(160deg, var(--sb-valid), #008f3a);
      box-shadow: 0 0 25px rgba(0, 255, 100, 0.6);
    }

    .expired {
      background: linear-gradient(160deg, var(--sb-expired), #a30000);
      box-shadow: 0 0 25px rgba(255, 50, 50, 0.6);
    }

    .cantiere {
      font-size: 18px;
      font-weight: 800;
      margin: 4px 0 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .nome {
      font-size: 20px;
      font-weight: 800;
      margin: 6px 0 2px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .azienda {
      font-size: 13px;
      margin: 0 0 12px;
      opacity: 0.9;
    }

    .info {
      font-size: 13px;
      opacity: 0.92;
      margin: 2px 0;
    }

    .scadenza {
      font-size: 20px;
      margin: 12px 0;
      font-weight: 400;
      text-transform: none;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(0, 0, 0, 0.18);
      margin-top: 6px;
    }

    .status {
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="brand-bar">
      <div class="brand-logo">SB</div>
      <div class="brand-title">Studio Borghi</div>
      <div class="card-label">Tessera operatore</div>
    </div>

    <div id="cantiere" class="cantiere"></div>
    <div id="nomeCompleto" class="nome"></div>
    <div id="azienda" class="azienda"></div>
    <div id="nascita" class="info"></div>
    <div id="scadenza" class="scadenza"></div>

    <div class="status-pill">
      <div id="status" class="status"></div>
    </div>
  </div>

<script>
  // ===== ENCODING HELPERS =====
  // RFC3986 strict encode (anche i caratteri ! ' ( ) *)
  const encodeRFC3986 = (str) =>
    encodeURIComponent(str).replace(/[!'()*]/g, c => '%' + c.charCodeAt(0).toString(16).toUpperCase());

  /**
   * Costruisce un URL sicuro con querystring encodata.
   * - base: ad es. location.origin + location.pathname
   * - params: oggetto { cantiere, nome, ... }
   *   - rimuove automaticamente chiavi con valori null/undefined/"" (stringa vuota)
   */
  function buildCardUrl(base, params = {}) {
    const url = new URL(base, window.location.origin);
    const qs = new URLSearchParams();

    for (const [k, v] of Object.entries(params)) {
      if (v == null) continue;
      const s = String(v).trim();
      if (!s) continue;
      // URLSearchParams esegue già la codifica percentuale corretta per chiavi/valori
      qs.set(k, s);
    }
    url.search = qs.toString();
    return url.toString();
  }

  // ===== LETTURA PARAMETRI =====
  const params = new URLSearchParams(window.location.search);
  const get = k => (params.get(k) || "").trim();

  const cantiere = get("cantiere");
  const nome = get("nome");
  const cognome = get("cognome");
  const azienda = get("azienda");
  const nascita = get("nascita");
  const scad = get("scad");

  const cardEl = document.getElementById("card");
  const cantiereEl = document.getElementById("cantiere");
  const nomeEl = document.getElementById("nomeCompleto");
  const aziendaEl = document.getElementById("azienda");
  const nascitaEl = document.getElementById("nascita");
  const scadenzaEl = document.getElementById("scadenza");
  const statusEl = document.getElementById("status");

  cantiereEl.textContent = cantiere || "CANTIERE NON SPECIFICATO";
  const fullName = (nome + " " + cognome).trim();
  nomeEl.textContent = fullName || "OPERATORE";

  if (azienda) aziendaEl.textContent = azienda;
  else aziendaEl.style.display = "none";

  if (nascita) nascitaEl.textContent = "Data di nascita: " + nascita;
  else nascitaEl.style.display = "none";

  let valido = false;
  if (scad) {
    const parts = scad.split("-");
    if (parts.length === 3) {
      const y = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10);
      const d = parseInt(parts[2], 10);
      if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
        const scadenzaDate = new Date(y, m - 1, d, 23, 59, 59);
        const today = new Date();
        today.setHours(0,0,0,0);
        valido = scadenzaDate >= today;
        scadenzaEl.textContent = "Valido fino al " +
          String(d).padStart(2,"0") + "/" +
          String(m).padStart(2,"0") + "/" + y;
      }
    }
  } else {
    scadenzaEl.textContent = "Scadenza non specificata";
  }

  if (valido) {
    cardEl.classList.add("valid");
    statusEl.textContent = "ABILITATO ALL'ACCESSO";
  } else {
    cardEl.classList.add("expired");
    statusEl.textContent = "NON ABILITATO";
  }

  // ===== ESEMPIO: URL "condivisibile" con encoding corretto =====
  // Usa il path corrente; se servirà usare segmenti di path dinamici falli passare da encodeRFC3986()
  const shareUrl = buildCardUrl(location.origin + location.pathname, {
    cantiere,
    nome,
    cognome,
    azienda,
    nascita,
    scad
  });
  console.log("URL condivisibile:", shareUrl);
</script>

</body>
</html>

